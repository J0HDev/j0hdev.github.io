<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS," />





  <link rel="alternate" href="/atom.xml" title="J0hnnny's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="读完这篇文章你可以自己写一个 YYModel 这样的神器，这篇文章类似一个源码解析，但不同的是，它不光光是解析，更是实战，因为我觉得学习一个东西必须要自己写一遍才算是真的学了一遍，否则即便是读完了源码印象还是不会太深刻，so，开始吧。
注：为了简单起见，我的例子只是实现了一个精简的版本，YYModel 有很多功能，我这里就实现了一个核心的功能，JSON -&amp;gt; Model。
注：文章的最后有完">
<meta property="og:type" content="article">
<meta property="og:title" content="手把手带你撸一个 YYModel 的精简版">
<meta property="og:url" content="http://yoursite.com/2016/09/02/手把手带你撸一个-YYModel-的精简版/index.html">
<meta property="og:site_name" content="J0hnnny's blog">
<meta property="og:description" content="读完这篇文章你可以自己写一个 YYModel 这样的神器，这篇文章类似一个源码解析，但不同的是，它不光光是解析，更是实战，因为我觉得学习一个东西必须要自己写一遍才算是真的学了一遍，否则即便是读完了源码印象还是不会太深刻，so，开始吧。
注：为了简单起见，我的例子只是实现了一个精简的版本，YYModel 有很多功能，我这里就实现了一个核心的功能，JSON -&amp;gt; Model。
注：文章的最后有完">
<meta property="og:updated_time" content="2016-09-02T07:09:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="手把手带你撸一个 YYModel 的精简版">
<meta name="twitter:description" content="读完这篇文章你可以自己写一个 YYModel 这样的神器，这篇文章类似一个源码解析，但不同的是，它不光光是解析，更是实战，因为我觉得学习一个东西必须要自己写一遍才算是真的学了一遍，否则即便是读完了源码印象还是不会太深刻，so，开始吧。
注：为了简单起见，我的例子只是实现了一个精简的版本，YYModel 有很多功能，我这里就实现了一个核心的功能，JSON -&amp;gt; Model。
注：文章的最后有完">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/09/02/手把手带你撸一个-YYModel-的精简版/"/>

  <title> 手把手带你撸一个 YYModel 的精简版 | J0hnnny's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b85d19362844a3394e8c3bc2325bb713";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">J0hnnny's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">欢迎造访 ^_^</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                手把手带你撸一个 YYModel 的精简版
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-02T15:08:08+08:00" content="2016-09-02">
              2016-09-02
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/02/手把手带你撸一个-YYModel-的精简版/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/02/手把手带你撸一个-YYModel-的精简版/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>读完这篇文章你可以自己写一个 YYModel 这样的神器，这篇文章类似一个源码解析，但不同的是，它不光光是解析，更是实战，因为我觉得学习一个东西必须要自己写一遍才算是真的学了一遍，否则即便是读完了源码印象还是不会太深刻，so，开始吧。</p>
<p><em>注：为了简单起见，我的例子只是实现了一个精简的版本，YYModel 有很多功能，我这里就实现了一个核心的功能，<code>JSON -&gt; Model</code>。</em></p>
<p><em>注：文章的最后有完整的代码</em></p>
<h2 id="从JSON映射到Model的原理"><a href="#从JSON映射到Model的原理" class="headerlink" title="从JSON映射到Model的原理"></a>从JSON映射到Model的原理</h2><p>想一下平时我们是怎么使用类似这样子的库的，当我们有一个JSON的时候，我们把所有JSON的字段（比如name、page）全部写成对应的类中的属性。然后库会自动把你JSON对应字段的值赋值到这些对应的属性里去。属性我们用 <code>@property</code> 来定义，就意味着编译器会帮你生成对应的<code>get``set</code>方法，我们使用的 <code>.</code> 其实也是在调用<code>get``set</code>方法来实现赋值的。在 Objective-C 中有一个著名的函数 <code>objc_msgSend(...)</code> 我们所有的类似 <code>[obj method]</code> 的方法调用（发送消息）都会被转换成 <code>objc_msgSend(...)</code> 的方式来调用。（具体这个函数怎么用后面再说）</p>
<p>所以对于一个库来说，要调用你这个 Model 的 <code>set</code> 方法，用 <code>objc_msgSend(...)</code> 会容易的多，所以JSON映射到Model的原理其实就是调用这个函数而已。</p>
<p>所以整个流程就是，你给我一个 Model 类，我会用 runtime 提供的各种函数来拿到你所有的属性和对应的<code>get``set</code>，判断完相应的类型以后，调用objc_msgSend(…)。说起来真的非常简单，做起来就有点麻烦…</p>
<h2 id="前期的准备工作"><a href="#前期的准备工作" class="headerlink" title="前期的准备工作"></a>前期的准备工作</h2><p>为了后面的方便，我们需要把一些关键的东西封装起来，我们需要单独封装 <code>ivar</code> <code>property</code> <code>method</code>，也就是实例变量、属性、方法，但事实上我们的这个精简版的YYModel并不需要 <code>method</code> <code>ivar</code> 的封装，为了保证完整性，我还是打算写下来。</p>
<h3 id="封装-ivar"><a href="#封装-ivar" class="headerlink" title="封装 ivar"></a>封装 ivar</h3><p>先来封装 <code>ivar</code>，看一下头文件 <code>CPClassIvarInfo.h</code>（YYModel只有4个文件，两个 <code>.h</code> 两个 <code>.m</code> 我为了让代码看起来更清楚，所以我自己在重写 YYModel 的时候把所有可以拆出来的类都分别拆成了一对<code>.h .m</code>）并把前缀改成了 CP 意思是 copy。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">#import &quot;CPCommon.h&quot;</span><br><span class="line"></span><br><span class="line">@interface CPClassIvarInfo : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign, readonly) Ivar ivar;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *name;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *typeEncoding;</span><br><span class="line">@property (nonatomic, assign, readonly) CPEncodingType type;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithIvar:(Ivar)ivar;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><code>Ivar</code> 代表一个实例变量，你所有和实例变量有关的操作都必须要把 <code>Ivar</code> 传进去，等一下就能看到。</p>
<p><code>name</code> 是这个实例变量的变量名</p>
<p><code>typeEncoding</code> 是对类型的编码，具体可以看<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">这里</a> 对于不同的类型就会有对应的编码，比如 <code>int</code> 就会变编码成 <code>i</code>，可以用 <code>@encode(int)</code>这样的操作来看一个类型的编码。</p>
<p><code>type</code> 是一个自定义的枚举，它描述了 YYMode 规定的类型。</p>
<h4 id="一个强大的枚举"><a href="#一个强大的枚举" class="headerlink" title="一个强大的枚举"></a>一个强大的枚举</h4><p>然后重新再创建一个文件（CPCommon），作为一个公共的文件 <code>CPEncodingType</code> 这个枚举就写在这里。</p>
<p>我们要创建的这个枚举需要一口气表示三种不同的类型，一种用于普通的类型上(<code>int double object</code>)，一种用来表示关键词(<code>const</code>)，一种表示 Property 的属性（<code>Nonatomic</code> <code>weak</code> <code>retain</code>）。</p>
<p>我们可以用位运算符来搞定这三种类型，用8位的枚举值来表示第一种，16位的表示第二种，24位的表示第三种，然后为了区别这三种类型都属于多少位的，我们可以分别搞三个 mask ，做一个该类型和某一个 mask 的与(&amp;)的操作就可以知道这个类型是具体是哪一个类型了，例子在后面。</p>
<p>这个枚举我们可以这样定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_OPTIONS(NSUInteger, CPEncodingType) &#123;</span><br><span class="line">    CPEncodingTypeMask       = 0xFF, //8 bit</span><br><span class="line">    CPEncodingTypeUnknown    = 0, </span><br><span class="line">    CPEncodingTypeVoid       = 1, </span><br><span class="line">    CPEncodingTypeBool       = 2, </span><br><span class="line">    CPEncodingTypeInt8       = 3, </span><br><span class="line">    CPEncodingTypeUInt8      = 4, </span><br><span class="line">    CPEncodingTypeInt16      = 5, </span><br><span class="line">    CPEncodingTypeUInt16     = 6, </span><br><span class="line">    CPEncodingTypeInt32      = 7, </span><br><span class="line">    CPEncodingTypeUInt32     = 8, </span><br><span class="line">    CPEncodingTypeInt64      = 9, </span><br><span class="line">    CPEncodingTypeUInt64     = 10,</span><br><span class="line">    CPEncodingTypeFloat      = 11,</span><br><span class="line">    CPEncodingTypeDouble     = 12,</span><br><span class="line">    CPEncodingTypeLongDouble = 13,</span><br><span class="line">    CPEncodingTypeObject     = 14,</span><br><span class="line">    CPEncodingTypeClass      = 15,</span><br><span class="line">    CPEncodingTypeSEL        = 16,</span><br><span class="line">    CPEncodingTypeBlock      = 17,</span><br><span class="line">    CPEncodingTypePointer    = 18,</span><br><span class="line">    CPEncodingTypeStruct     = 19,</span><br><span class="line">    CPEncodingTypeUnion      = 20,</span><br><span class="line">    CPEncodingTypeCString    = 21,</span><br><span class="line">    CPEncodingTypeCArray     = 22,</span><br><span class="line">    </span><br><span class="line">    CPEncodingTypeQualifierMask   = 0xFF00,  //16 bit</span><br><span class="line">    CPEncodingTypeQualifierConst  = 1 &lt;&lt; 8,  </span><br><span class="line">    CPEncodingTypeQualifierIn     = 1 &lt;&lt; 9,  </span><br><span class="line">    CPEncodingTypeQualifierInout  = 1 &lt;&lt; 10, </span><br><span class="line">    CPEncodingTypeQualifierOut    = 1 &lt;&lt; 11, </span><br><span class="line">    CPEncodingTypeQualifierBycopy = 1 &lt;&lt; 12, </span><br><span class="line">    CPEncodingTypeQualifierByref  = 1 &lt;&lt; 13, </span><br><span class="line">    CPEncodingTypeQualifierOneway = 1 &lt;&lt; 14,</span><br><span class="line">    </span><br><span class="line">    CPEncodingTypePropertyMask         = 0xFF0000, // 24 bit</span><br><span class="line">    CPEncodingTypePropertyReadonly     = 1 &lt;&lt; 16, </span><br><span class="line">    CPEncodingTypePropertyCopy         = 1 &lt;&lt; 17, </span><br><span class="line">    CPEncodingTypePropertyRetain       = 1 &lt;&lt; 18, </span><br><span class="line">    CPEncodingTypePropertyNonatomic    = 1 &lt;&lt; 19, </span><br><span class="line">    CPEncodingTypePropertyWeak         = 1 &lt;&lt; 20, </span><br><span class="line">    CPEncodingTypePropertyCustomGetter = 1 &lt;&lt; 21, </span><br><span class="line">    CPEncodingTypePropertyCustomSetter = 1 &lt;&lt; 22, </span><br><span class="line">    CPEncodingTypePropertyDynamic      = 1 &lt;&lt; 23,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>比如有一个类型是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPEncodingType type = CPEncodingTypeDouble;</span><br></pre></td></tr></table></figure>
<p>假设我们并不知道它是 <code>CPEncodingTypeDouble</code> 类型，那我们要怎么样才能知道它是什么类型呢？只要这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSLog(@&quot;%lu&quot;,type &amp; CPEncodingTypeMask);</span><br></pre></td></tr></table></figure>
<p>输出： 12</p>
<p>在枚举的定义中 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPEncodingTypeDouble     = 12,</span><br></pre></td></tr></table></figure>
<p>假设这个枚举值有很多种混在一起</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CPEncodingType type = CPEncodingTypeDouble | CPEncodingTypePropertyRetain;</span><br><span class="line">NSLog(@&quot;%lu&quot;,type &amp; CPEncodingTypePropertyMask); //输出 262144 (1&lt;&lt;18的十进制表示)</span><br><span class="line">NSLog(@&quot;%lu&quot;,type &amp; CPEncodingTypeMask); //输出 12</span><br></pre></td></tr></table></figure>
<p>可能有人知道这种神奇的用法，但在我读YYModel之前我没用过这种方法（技术比较菜）。</p>
<p>然后还有一个函数，这个函数可以把类型编码（Type Encoding）转换成刚才的枚举值，很简单却很长的一个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">CPEncodingType CPEncodingGetType(const char *typeEncoding) &#123;</span><br><span class="line">    char *type = (char *)typeEncoding;</span><br><span class="line">    if (!type) return CPEncodingTypeUnknown;</span><br><span class="line">    size_t len = strlen(type);</span><br><span class="line">    if (len == 0) return CPEncodingTypeUnknown;</span><br><span class="line">    </span><br><span class="line">    CPEncodingType qualifier = 0;</span><br><span class="line">    bool prefix = true;</span><br><span class="line">    while (prefix) &#123;</span><br><span class="line">        switch (*type) &#123;</span><br><span class="line">            case &apos;r&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierConst;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            case &apos;n&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierIn;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            case &apos;N&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierInout;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            case &apos;o&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierOut;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            case &apos;O&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierBycopy;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            case &apos;R&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierByref;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            case &apos;V&apos;: &#123;</span><br><span class="line">                qualifier |= CPEncodingTypeQualifierOneway;</span><br><span class="line">                type++;</span><br><span class="line">            &#125; break;</span><br><span class="line">            default: &#123; prefix = false; &#125; break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    len = strlen(type);</span><br><span class="line">    if (len == 0) return CPEncodingTypeUnknown | qualifier;</span><br><span class="line">    </span><br><span class="line">    switch (*type) &#123;</span><br><span class="line">        case &apos;v&apos;: return CPEncodingTypeVoid | qualifier;</span><br><span class="line">        case &apos;B&apos;: return CPEncodingTypeBool | qualifier;</span><br><span class="line">        case &apos;c&apos;: return CPEncodingTypeInt8 | qualifier;</span><br><span class="line">        case &apos;C&apos;: return CPEncodingTypeUInt8 | qualifier;</span><br><span class="line">        case &apos;s&apos;: return CPEncodingTypeInt16 | qualifier;</span><br><span class="line">        case &apos;S&apos;: return CPEncodingTypeUInt16 | qualifier;</span><br><span class="line">        case &apos;i&apos;: return CPEncodingTypeInt32 | qualifier;</span><br><span class="line">        case &apos;I&apos;: return CPEncodingTypeUInt32 | qualifier;</span><br><span class="line">        case &apos;l&apos;: return CPEncodingTypeInt32 | qualifier;</span><br><span class="line">        case &apos;L&apos;: return CPEncodingTypeUInt32 | qualifier;</span><br><span class="line">        case &apos;q&apos;: return CPEncodingTypeInt64 | qualifier;</span><br><span class="line">        case &apos;Q&apos;: return CPEncodingTypeUInt64 | qualifier;</span><br><span class="line">        case &apos;f&apos;: return CPEncodingTypeFloat | qualifier;</span><br><span class="line">        case &apos;d&apos;: return CPEncodingTypeDouble | qualifier;</span><br><span class="line">        case &apos;D&apos;: return CPEncodingTypeLongDouble | qualifier;</span><br><span class="line">        case &apos;#&apos;: return CPEncodingTypeClass | qualifier;</span><br><span class="line">        case &apos;:&apos;: return CPEncodingTypeSEL | qualifier;</span><br><span class="line">        case &apos;*&apos;: return CPEncodingTypeCString | qualifier;</span><br><span class="line">        case &apos;^&apos;: return CPEncodingTypePointer | qualifier;</span><br><span class="line">        case &apos;[&apos;: return CPEncodingTypeCArray | qualifier;</span><br><span class="line">        case &apos;(&apos;: return CPEncodingTypeUnion | qualifier;</span><br><span class="line">        case &apos;&#123;&apos;: return CPEncodingTypeStruct | qualifier;</span><br><span class="line">        case &apos;@&apos;: &#123;</span><br><span class="line">            if (len == 2 &amp;&amp; *(type + 1) == &apos;?&apos;)</span><br><span class="line">                return CPEncodingTypeBlock | qualifier;</span><br><span class="line">            else</span><br><span class="line">                return CPEncodingTypeObject | qualifier;</span><br><span class="line">        &#125;</span><br><span class="line">        default: return CPEncodingTypeUnknown | qualifier;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单，不用多讲了。</p>
<p>回到 CPClassIvarInfo 刚才我们只给出了头文件，现在看一下实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithIvar:(Ivar)ivar &#123;</span><br><span class="line">    if (!ivar)&#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self)&#123;</span><br><span class="line">        _ivar = ivar;</span><br><span class="line">        const char *name = ivar_getName(ivar);</span><br><span class="line">        if (name)&#123;</span><br><span class="line">            _name = [NSString stringWithUTF8String:name];</span><br><span class="line">        &#125;</span><br><span class="line">        const char *typeEncoding = ivar_getTypeEncoding(ivar);</span><br><span class="line">        if (typeEncoding)&#123;</span><br><span class="line">            _typeEncoding = [NSString stringWithUTF8String:typeEncoding];</span><br><span class="line">            _type = CPEncodingGetType(typeEncoding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有一个方法，这里就用到了两个 runtime 函数 <code>ivar_getName(ivar)</code> 和 <code>ivar_getTypeEncoding(ivar)</code> 传入 ivar 就行。</p>
<h3 id="封装Method"><a href="#封装Method" class="headerlink" title="封装Method"></a>封装Method</h3><p>然后看一下对于 Method 的封装，看一下头文件（CPClassMethodInfo.h）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line"></span><br><span class="line">@interface CPClassMethodInfo : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign, readonly) Method method;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *name;</span><br><span class="line">@property (nonatomic, assign, readonly) SEL sel;</span><br><span class="line">@property (nonatomic, assign, readonly) IMP imp;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *typeEncoding;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *returnTypeEncoding;</span><br><span class="line">@property (nullable, nonatomic, strong, readonly) NSArray&lt;NSString *&gt; *argumentTypeEncodings;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithMethod:(Method)method;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_END</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h4 id="Objective-C-的-Optional"><a href="#Objective-C-的-Optional" class="headerlink" title="Objective-C 的 Optional"></a>Objective-C 的 Optional</h4><p><code>NS_ASSUME_NONNULL_BEGIN</code> 和 <code>NS_ASSUME_NONNULL_END</code> 是成对出现的，因为 Swift 可以和 Objective-C 混用，但是 Swift 有 Optional 类型，而 Objective-C 没有这样的概念，为了和 Swift 保持一致，现在 Objective-C 有了 <code>_Nullable 可空</code> <code>_Nonnull不可空</code>这样的关键字，这两个关键字可以在变量、方法返回值、方法参数上使用，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong) NSString  * _Nonnull string;</span><br><span class="line"></span><br><span class="line">- (NSString * _Nonnull)method:(NSString *_Nonnull)string;</span><br></pre></td></tr></table></figure>
<p>还有另外一对 <code>nullable</code> <code>nonnull</code>，它们可以这样用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@property (nullable, nonatomic, strong) NSString  *string;</span><br><span class="line"></span><br><span class="line">- (nullable NSString *)method:(nullable NSString *)string;</span><br></pre></td></tr></table></figure>
<p>对了，这些关键词只能用在指针上，其他类型是不能用的。</p>
<p>当你一旦在某个地方写上关键词 <code>nullable</code>的时候，编译器就会提出警告，Pointer is missing a nullability type specifier (_Nonnull, _Nullable, or _Null_unspecified) 然后你就可以加上<code>NS_ASSUME_NONNULL_BEGIN</code> 和 <code>NS_ASSUME_NONNULL_END</code>来表示只有我标记为 <code>nullable</code> 的地方才可空，其余地方都是 <code>nonnull</code>。</p>
<p>回到刚才的头文件代码，<code>method</code> 表示一个方法</p>
<p><code>name</code> 很明显就是方法名了</p>
<p><code>sel</code> 和 <code>imp</code> 是一个对应关系，一个对象的所有方法都会保存在一张表里，通过 <code>sel</code> 就能找到这个方法的 <code>imp</code>，我讲的可能有点简单，如果想要深入的了解可以查一下文档或者博客。</p>
<p><code>typeEncoding</code> 又是一个编码，这里是参数和返回值的编码</p>
<p><code>returnTypeEncoding</code> 返回值的编码</p>
<p><code>argumentTypeEncodings</code> 所有参数的编码</p>
<p>实现还是很简单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithMethod:(Method)method &#123;</span><br><span class="line">    if (!method) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self)&#123;</span><br><span class="line">        _method = method;</span><br><span class="line">        _sel = method_getName(method);</span><br><span class="line">        _imp = method_getImplementation(method);</span><br><span class="line">        const char *name = sel_getName(_sel);</span><br><span class="line">        if (name) &#123;</span><br><span class="line">            _name = [NSString stringWithUTF8String:name];</span><br><span class="line">        &#125;</span><br><span class="line">        const char *typeEncoding = method_getTypeEncoding(method);</span><br><span class="line">        if (typeEncoding) &#123;</span><br><span class="line">            _typeEncoding = [NSString stringWithUTF8String:typeEncoding];</span><br><span class="line">        &#125;</span><br><span class="line">        char *returnTypeEncoding = method_copyReturnType(method);</span><br><span class="line">        if (returnTypeEncoding) &#123;</span><br><span class="line">            _returnTypeEncoding = [NSString stringWithUTF8String:returnTypeEncoding];</span><br><span class="line">            free(returnTypeEncoding);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        //得到参数的数目，遍历取得所有参数的类型</span><br><span class="line">        unsigned int count = method_getNumberOfArguments(method);</span><br><span class="line">        if (count &gt; 0) &#123;</span><br><span class="line">            NSMutableArray *types = [[NSMutableArray alloc] initWithCapacity:10];</span><br><span class="line">            for (unsigned int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">                char *argumentsType = method_copyArgumentType(method, i);</span><br><span class="line">                NSString *type = argumentsType ? [NSString stringWithUTF8String:argumentsType] : nil;</span><br><span class="line">                [types addObject:type ? type : @&quot;&quot;];</span><br><span class="line">                if (argumentsType) &#123;</span><br><span class="line">                    free(argumentsType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _argumentTypeEncodings = types;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和前面套路一样。</p>
<h3 id="封装-Property"><a href="#封装-Property" class="headerlink" title="封装 Property"></a>封装 Property</h3><p>老样子，看头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">#import &quot;CPCommon.h&quot;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line"></span><br><span class="line">@interface CPClassPropertyInfo : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign, readonly) objc_property_t property;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *name;</span><br><span class="line">@property (nonatomic, assign, readonly) CPEncodingType type;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *typdEncoding;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *ivarName;</span><br><span class="line">@property (nullable, nonatomic, assign, readonly) Class cls;</span><br><span class="line">@property (nonatomic, assign, readonly) SEL getter;</span><br><span class="line">@property (nonatomic, assign, readonly) SEL setter;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithProperty:(objc_property_t)property;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_END</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>这是在精简版的YYModel中会用到的一个类，这里尤其要注意的是<code>type</code>和<code>typdEncoding</code>两个属性，希望读者能够仔细调试一下，看一下主要的一段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">CPEncodingType type = 0;</span><br><span class="line">unsigned int outCount;</span><br><span class="line">objc_property_attribute_t *attrs = property_copyAttributeList(property, &amp;outCount);</span><br><span class="line">//遍历所有的Property的属性</span><br><span class="line">for (unsigned int i = 0; i &lt; outCount; i++) &#123;</span><br><span class="line">    switch (attrs[i].name[0]) &#123;</span><br><span class="line">        case &apos;T&apos;:</span><br><span class="line">            if (attrs[i].value) &#123;</span><br><span class="line">                _typdEncoding = [NSString stringWithUTF8String:attrs[i].value];</span><br><span class="line">                type = CPEncodingGetType(attrs[i].value);</span><br><span class="line">                </span><br><span class="line">                if((type &amp; CPEncodingTypeMask) == CPEncodingTypeObject)&#123;</span><br><span class="line">                    //如果该类型为一个对象 比如 @&quot;NSString&quot; ,截取中间的，结果为 NSString，目的是为了得到这个类的 Class</span><br><span class="line">                    size_t len = strlen(attrs[i].value);</span><br><span class="line">                    if (len &gt; 3) &#123;</span><br><span class="line">                        char name[len - 2];</span><br><span class="line">                        name[len - 3] = &apos;\0&apos;;</span><br><span class="line">                        memcpy(name, attrs[i].value + 2, len - 3);</span><br><span class="line">                        _cls = objc_getClass(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">            case &apos;V&apos;:</span><br><span class="line">                if (attrs[i].value) &#123;</span><br><span class="line">                    _ivarName = [NSString stringWithUTF8String:attrs[i].value];</span><br><span class="line">                &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case &apos;R&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyReadonly;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case &apos;C&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyCopy;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case &apos;&amp;&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyRetain;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case &apos;N&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyNonatomic;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case &apos;D&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyDynamic;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case &apos;W&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyWeak;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        case  &apos;G&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyCustomGetter;</span><br><span class="line">            if (attrs[i].value) &#123;</span><br><span class="line">                _getter = NSSelectorFromString([NSString stringWithUTF8String:attrs[i].value]);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        </span><br><span class="line">        case &apos;S&apos;:</span><br><span class="line">            type |= CPEncodingTypePropertyCustomSetter;</span><br><span class="line">            if (attrs[i].value) &#123;</span><br><span class="line">                _setter = NSSelectorFromString([NSString stringWithUTF8String:attrs[i].value]);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">            </span><br><span class="line">        default: break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过<code>property_copyAttributeList</code>这个函数得到一个指向一个结构体<code>objc_property_attribute_t</code>的指针，这个结构体的结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    const char *name;           /**&lt; The name of the attribute */</span><br><span class="line">    const char *value;          /**&lt; The value of the attribute (usually empty) */</span><br><span class="line">&#125; objc_property_attribute_t;</span><br></pre></td></tr></table></figure>
<p>说是一个指针，其实它是一个结构体数组，指针指向的其实是这个数组第一个元素。</p>
<p>这个结构体表示的是一个 Property 的属性，关于 Property 的类型编码可以看<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW5" target="_blank" rel="external">这里</a></p>
<p>要说清这个数组里每一个结构体元素的<code>name</code>和<code>value</code>都存了什么，我们可以看一下下面这段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class cls = objc_getClass(&quot;CPBook&quot;);</span><br><span class="line">objc_property_t property = class_getProperty(cls, &quot;name&quot;);</span><br><span class="line">const char* attr = property_getAttributes(property);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr);</span><br></pre></td></tr></table></figure>
<p>这里比如有一个类是 CPBook ，我们通过这个类的 Class 来拿到一个叫做 name 的 Property，然后在拿到这个 Property 所有属性，输出的结果是 <code>T@&quot;NSString&quot;,&amp;,N,V_name</code></p>
<p>其实，我们用和上面一样返回一个结构体数组的方式来获取这个 Property 的属性的话，那么这个结构体应该会有4个元素。</p>
<p>第一个元素 <code>name = T</code>，<code>value = @&quot;NSString&quot;</code>，第二个元素 <code>name = &amp;</code>，<code>value 没有值</code>，第三个元素 <code>name = N</code>，<code>value 仍然没有值</code>，第四个元素 <code>name = V</code>，<code>value = _name</code>。不信可以运行一下下面的代码来看看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Class cls = objc_getClass(&quot;CPBook&quot;);</span><br><span class="line">unsigned int acount;</span><br><span class="line">objc_property_t *prop = class_copyPropertyList(cls, &amp;acount);</span><br><span class="line">    </span><br><span class="line">objc_property_attribute_t *attr1 = property_copyAttributeList(prop[2], &amp;acount);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[0].name);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[0].value);</span><br><span class="line">NSLog(@&quot;-------------------&quot;);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[1].name);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[1].value);</span><br><span class="line">NSLog(@&quot;-------------------&quot;);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[2].name);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[2].value);</span><br><span class="line">NSLog(@&quot;-------------------&quot;);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[3].name);</span><br><span class="line">NSLog(@&quot;%s&quot;,attr1[3].value);</span><br></pre></td></tr></table></figure>
<p>至于 V N &amp; 这样的符号是什么意思，可以打开上面给出的链接自己看一下文档，一看便知。</p>
<p>这样一来在 switch 分支中，只要匹配到 T 就能得到这个 Property 的类型是什么，这样就可以得到这个类型的 Type Encoding，并且能够得到该类的 Class。只要匹配到 V 就能得到这个 Property 实例变量名。</p>
<p>该类全部代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithProperty:(objc_property_t)property &#123;</span><br><span class="line">    if (!property) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        _property = property;</span><br><span class="line">        const char *name = property_getName(property);</span><br><span class="line">        if (name) &#123;</span><br><span class="line">            _name = [NSString stringWithUTF8String:name];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        CPEncodingType type = 0;</span><br><span class="line">        unsigned int outCount;</span><br><span class="line">        objc_property_attribute_t *attrs = property_copyAttributeList(property, &amp;outCount);</span><br><span class="line">        //遍历所有的Property的属性</span><br><span class="line">        for (unsigned int i = 0; i &lt; outCount; i++) &#123;</span><br><span class="line">            switch (attrs[i].name[0]) &#123;</span><br><span class="line">                case &apos;T&apos;:</span><br><span class="line">                    if (attrs[i].value) &#123;</span><br><span class="line">                        _typdEncoding = [NSString stringWithUTF8String:attrs[i].value];</span><br><span class="line">                        type = CPEncodingGetType(attrs[i].value);</span><br><span class="line">                        </span><br><span class="line">                        if((type &amp; CPEncodingTypeMask) == CPEncodingTypeObject)&#123;</span><br><span class="line">                            //如果该类型为一个对象 比如 @&quot;NSString&quot; ,截取中间的，结果为 NSString，目的是为了得到这个类的 Class</span><br><span class="line">                            size_t len = strlen(attrs[i].value);</span><br><span class="line">                            if (len &gt; 3) &#123;</span><br><span class="line">                                char name[len - 2];</span><br><span class="line">                                name[len - 3] = &apos;\0&apos;;</span><br><span class="line">                                memcpy(name, attrs[i].value + 2, len - 3);</span><br><span class="line">                                _cls = objc_getClass(name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                    case &apos;V&apos;:</span><br><span class="line">                        if (attrs[i].value) &#123;</span><br><span class="line">                            _ivarName = [NSString stringWithUTF8String:attrs[i].value];</span><br><span class="line">                        &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case &apos;R&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyReadonly;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case &apos;C&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyCopy;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case &apos;&amp;&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyRetain;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case &apos;N&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyNonatomic;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case &apos;D&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyDynamic;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case &apos;W&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyWeak;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case  &apos;G&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyCustomGetter;</span><br><span class="line">                    if (attrs[i].value) &#123;</span><br><span class="line">                        _getter = NSSelectorFromString([NSString stringWithUTF8String:attrs[i].value]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                </span><br><span class="line">                case &apos;S&apos;:</span><br><span class="line">                    type |= CPEncodingTypePropertyCustomSetter;</span><br><span class="line">                    if (attrs[i].value) &#123;</span><br><span class="line">                        _setter = NSSelectorFromString([NSString stringWithUTF8String:attrs[i].value]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                default: break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (attrs) &#123;</span><br><span class="line">            free(attrs);</span><br><span class="line">            attrs = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        _type = type;</span><br><span class="line">        </span><br><span class="line">        if (_name.length) &#123;</span><br><span class="line">            if (!_getter) &#123;</span><br><span class="line">                _getter = NSSelectorFromString(_name);</span><br><span class="line">            &#125;</span><br><span class="line">            if (!_setter) &#123;</span><br><span class="line">                _setter = NSSelectorFromString([NSString stringWithFormat:@&quot;set%@%@:&quot;,[_name substringToIndex:1].uppercaseString, [_name substringFromIndex:1]]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来，我们就有了 ivar Method Property 的封装类。接下来，我们需要一个叫做<code>CPClassInfo</code>的类，来封装一些类的信息，并且把以上三个类也封装进去，用来描述整个类。</p>
<h3 id="封装-Class"><a href="#封装-Class" class="headerlink" title="封装 Class"></a>封装 Class</h3><p>继续看头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line">@class CPClassIvarInfo;</span><br><span class="line">@class CPClassMethodInfo;</span><br><span class="line">@class CPClassPropertyInfo;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line"></span><br><span class="line">@interface CPClassInfo : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign, readonly) Class cls;</span><br><span class="line">@property (nonatomic, assign, readonly) Class superClass;</span><br><span class="line">@property (nonatomic, assign, readonly) Class metaClass;</span><br><span class="line">@property (nonatomic, readonly) BOOL isMeta;</span><br><span class="line">@property (nonatomic, strong, readonly) NSString *name;</span><br><span class="line">@property (nullable, nonatomic, strong, readonly) CPClassInfo *superClassInfo;</span><br><span class="line">@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, CPClassIvarInfo *&gt; *ivarInfos;</span><br><span class="line">@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, CPClassMethodInfo *&gt; *methodInfos;</span><br><span class="line">@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, CPClassPropertyInfo *&gt; *propertyInfos;</span><br><span class="line"></span><br><span class="line">- (void)setNeedUpadte;</span><br><span class="line">- (BOOL)needUpdate;</span><br><span class="line">+ (nullable instancetype)classInfoWithClass:(Class)cls;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_END</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><code>Class</code> 类型用来描述一个类，你可以使用 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">model.class</span><br><span class="line">[model class]</span><br><span class="line">[CPTestModel class]</span><br><span class="line">object_getClass(model)</span><br></pre></td></tr></table></figure>
<p>等方法来取到这个 Class。·<em>注意<code>object_getClass()</code>和其他方式 有些不同具体看<a href="http://www.jianshu.com/p/ae5c32708bc6" target="_blank" rel="external">这里</a></em></p>
<p>其余的 Property 不用多介绍了，看到它们的名字就大概能猜到干嘛的了。</p>
<p>最后的几个 <code>NSDictionary</code> 用来存所有的 ivar Method Property。</p>
<p>有些时候，一个类有可能被更改，可能改掉了方法或者是 Property，那么这时候应该通知<code>CPClassInfo</code>来重新获取到更改过后的类的信息。所以我们有两个相关的方法来实现这个目的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (void)setNeedUpadte;</span><br><span class="line">- (BOOL)needUpdate;</span><br></pre></td></tr></table></figure>
<p>先来看一下初始化方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithClass:(Class)cls&#123;</span><br><span class="line">    if (!cls) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        _cls = cls;</span><br><span class="line">        _superClass = class_getSuperclass(cls);</span><br><span class="line">        _isMeta = class_isMetaClass(cls);</span><br><span class="line">        if (_isMeta) &#123;</span><br><span class="line">            _metaClass = objc_getMetaClass(class_getName(cls));</span><br><span class="line">        &#125;</span><br><span class="line">        _name = NSStringFromClass(cls);</span><br><span class="line">        [self _update];</span><br><span class="line">        </span><br><span class="line">        _superClassInfo = [self.class classInfoWithClass:_superClass];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你没看错，这和头文件定义的<code>classInfoWithClass:</code>不是一个方法，头文件定义的那个方法用来缓存，因为实例化这个方法还是有点开销的，所以没有必要每一次都去实例化。</p>
<p>这里有一个 <code>_update</code> 方法，刚才说过，如果这个类会在某一个时刻发生变化，应该通知，收到通知后，我们去执行一些更新的操作，所以把会发生变化的一部分代码单独拿出来更好，现在看一下 <code>_update</code> 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">- (void)_update&#123;</span><br><span class="line">    _ivarInfos = nil;</span><br><span class="line">    _propertyInfos = nil;</span><br><span class="line">    _methodInfos = nil;</span><br><span class="line">    </span><br><span class="line">    unsigned int ivarCount = 0;</span><br><span class="line">    Ivar *ivars = class_copyIvarList(self.cls, &amp;ivarCount);</span><br><span class="line">    if (ivars) &#123;</span><br><span class="line">        _ivarInfos = [NSMutableDictionary new];</span><br><span class="line">        for (unsigned int i = 0; i &lt; ivarCount; i++) &#123;</span><br><span class="line">            CPClassIvarInfo *ivarInfo = [[CPClassIvarInfo alloc] initWithIvar:ivars[i]];</span><br><span class="line">            if (ivarInfo.name) &#123;</span><br><span class="line">                [_ivarInfos setValue:ivarInfo forKey:ivarInfo.name];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        free(ivars);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    unsigned int propertyCount = 0;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList(self.cls, &amp;propertyCount);</span><br><span class="line">    if (properties) &#123;</span><br><span class="line">        _propertyInfos = [NSMutableDictionary new];</span><br><span class="line">        for (unsigned int i = 0; i &lt; propertyCount; i++) &#123;</span><br><span class="line">            CPClassPropertyInfo *propertyInfo = [[CPClassPropertyInfo alloc] initWithProperty:properties[i]];</span><br><span class="line">            if (propertyInfo.name) &#123;</span><br><span class="line">                [_propertyInfos setValue:propertyInfo forKey:propertyInfo.name];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        free(properties);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    unsigned int methodCount = 0;</span><br><span class="line">    Method *methods = class_copyMethodList(self.cls, &amp;methodCount);</span><br><span class="line">    if (methods) &#123;</span><br><span class="line">        _methodInfos = [NSMutableDictionary new];</span><br><span class="line">        for (unsigned int i = 0; i &lt; methodCount; i++) &#123;</span><br><span class="line">            CPClassMethodInfo *methodInfo = [[CPClassMethodInfo alloc] initWithMethod:methods[i]];</span><br><span class="line">            if (methodInfo.name) &#123;</span><br><span class="line">                [_methodInfos setValue:methodInfo forKey:methodInfo.name];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        free(methods);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (!_ivarInfos) &#123;</span><br><span class="line">        _ivarInfos = @&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!_methodInfos) &#123;</span><br><span class="line">        _methodInfos = @&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!_propertyInfos) &#123;</span><br><span class="line">        _propertyInfos = @&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    _needUpdate = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这个方法就是拿到一个类所有的 ivar Method Property ，一个类发生变化是不是主要就是这三个玩意的变化？</p>
<p>最后一行的 <code>_needUpdate</code> 是一个全局变量，用来标识是否发生的变化，它被定义在这里，以免暴露给外面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@implementation CPClassInfo&#123;</span><br><span class="line">    BOOL _needUpdate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当外界需要通知自己已经发生变化或者查一下是否发生变化时就调用这两个相关方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)needUpdate &#123;</span><br><span class="line">    return _needUpdate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setNeedUpadte &#123;</span><br><span class="line">    _needUpdate = YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在来看一下<code>classInfoWithClass:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)classInfoWithClass:(Class)cls&#123;</span><br><span class="line">    if (!cls) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    static NSMutableDictionary *metaCache;</span><br><span class="line">    static NSMutableDictionary *classCache;</span><br><span class="line">    static dispatch_semaphore_t lock;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        metaCache = [NSMutableDictionary dictionary];</span><br><span class="line">        classCache = [NSMutableDictionary dictionary];</span><br><span class="line">        lock = dispatch_semaphore_create(1);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    CPClassInfo *info;</span><br><span class="line">    if (class_isMetaClass(cls)) &#123;</span><br><span class="line">        info = [metaCache valueForKey:NSStringFromClass(cls)];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        info = [classCache valueForKey:NSStringFromClass(cls)];</span><br><span class="line">    &#125;</span><br><span class="line">    if (info &amp;&amp; info-&gt;_needUpdate) &#123;</span><br><span class="line">        [info _update];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_semaphore_signal(lock);</span><br><span class="line">    </span><br><span class="line">    if (!info) &#123;</span><br><span class="line">        info = [[CPClassInfo alloc] initWithClass:cls];</span><br><span class="line">        if (info) &#123;</span><br><span class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            if (info.isMeta) &#123;</span><br><span class="line">                [metaCache setValue:info forKey:NSStringFromClass(cls)];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                [classCache setValue:info forKey:NSStringFromClass(cls)];</span><br><span class="line">            &#125;</span><br><span class="line">            dispatch_semaphore_signal(lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个 <code>NSMutableDictionary</code> 都是用来缓存的，并声明在了静态区，并且使用<code>dispatch_once()</code>来确保只会被初始化一次，然后我们需要保证线程安全，因为有可能会在多线程的场景里被用到，所以使用信号量<code>dispatch_semaphore_t</code>来搞定，信号量就像停车这样的场景一样，如果发现车满了，就等待，一有空位就放行，也就是说，当一个线程要进入临界区的时候，必须获取一个信号量，如果没有问题就进入临界区，这时另一个线程进来了，也要获取，发现信号量并没有释放，就继续等待，直到前面一个信号量被释放后，该线程才准许进入。我们可以使用<code>dispatch_semaphore_wait()</code>来获取信号量，通过<code>dispatch_semaphore_signal()</code>来释放信号量。</p>
<p>在这段代码里，我们首先确保要实例化的这个对象有没有被缓存，用传进来的 <code>cls</code> 作为 <code>key</code>，如果缓存命中，那直接取出缓存，然后判断一下，有没有更新，如果有更新，调用<code>_update</code>刷新一遍，返回，否则直接返回。缓存没有命中的话，还是乖乖的调用实例化方法，然后缓存起来。</p>
<h3 id="继续封装"><a href="#继续封装" class="headerlink" title="继续封装"></a>继续封装</h3><h4 id="CPModelPropertyMeta"><a href="#CPModelPropertyMeta" class="headerlink" title="CPModelPropertyMeta"></a>CPModelPropertyMeta</h4><p>先建一个文件，叫做 <code>CPMeta.h</code> 和 <code>CPMeta.m</code>，我们要在这里写两个类，一个是对 Property 的再次封装，一个是对 Class 的再次封装。</p>
<p>我直接把头文件代码全拿出来了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">#import &quot;CPCommon.h&quot;</span><br><span class="line">@class CPClassInfo;</span><br><span class="line">@class CPClassPropertyInfo;</span><br><span class="line"></span><br><span class="line">typedef NS_ENUM (NSUInteger, CPEncodingNSType) &#123;</span><br><span class="line">    CPEncodingTypeNSUnknown = 0,</span><br><span class="line">    CPEncodingTypeNSString,</span><br><span class="line">    CPEncodingTypeNSMutableString,</span><br><span class="line">    CPEncodingTypeNSValue,</span><br><span class="line">    CPEncodingTypeNSNumber,</span><br><span class="line">    CPEncodingTypeNSDecimalNumber,</span><br><span class="line">    CPEncodingTypeNSData,</span><br><span class="line">    CPEncodingTypeNSMutableData,</span><br><span class="line">    CPEncodingTypeNSDate,</span><br><span class="line">    CPEncodingTypeNSURL,</span><br><span class="line">    CPEncodingTypeNSArray,</span><br><span class="line">    CPEncodingTypeNSMutableArray,</span><br><span class="line">    CPEncodingTypeNSDictionary,</span><br><span class="line">    CPEncodingTypeNSMutableDictionary,</span><br><span class="line">    CPEncodingTypeNSSet,</span><br><span class="line">    CPEncodingTypeNSMutableSet,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@interface CPModelMeta : NSObject&#123;</span><br><span class="line">    @package</span><br><span class="line">    CPClassInfo *_clsInfo;</span><br><span class="line">    NSDictionary *_mapper;</span><br><span class="line">    NSArray *_allPropertyMetas;</span><br><span class="line">    NSUInteger _keyMappedCount;</span><br><span class="line">    CPEncodingNSType _nsType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)metaWithClass:(Class)cls;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface CPModelPropertyMeta : NSObject&#123;</span><br><span class="line">    @package</span><br><span class="line">    NSString *_name;</span><br><span class="line">    CPEncodingType _type;</span><br><span class="line">    CPEncodingNSType _nsType;</span><br><span class="line">    BOOL _isCNumber;</span><br><span class="line">    Class _cls;</span><br><span class="line">    Class _genericCls;</span><br><span class="line">    SEL _getter;</span><br><span class="line">    SEL _setter;</span><br><span class="line">    BOOL _isKVCCompatible;</span><br><span class="line">    NSString *_mappedToKey;</span><br><span class="line">    CPClassPropertyInfo *_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)modelWithClassInfo:(CPClassInfo *)clsInfo propretyInfo:(CPClassPropertyInfo *)propertyInfo generic:(Class)generic;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>可以看到这里有两个类，姑且叫做 <code>CPModelPropertyMeta</code> 和 <code>CPModelMeta</code> 以及一个枚举，这个枚举表示一个NS的类型，因为在上一个枚举当中，我们对于对象只定义了 <code>CPEncodingTypeObject</code> 这一个类型，没法区分它到底是 <code>NSString</code> 还是别的，所以这里要细化一下，类型判断清楚很重要，如果不把这部分做好，那么在JSON转换的时候，类型上出错就直接蹦了。</p>
<p>先来看一下 <code>CPModelPropertyMeta</code> 。（在 YYModel 中，这两个类其实是和一个叫做<code>NSObject+CPModel</code>的扩展放在一起的，但是我强制把它们拆出来了，为了看起来清楚，所以我把 <code>@package</code> 的成员变量都写到了 interface 里面，这么做是不合理的，但这里为了清晰和学习起见，所以我乱来了。）这个类中多了几个成员变量，我就说几个看起来不那么清楚的成员变量。</p>
<p><code>_isCNumber</code> 这里变量表示是不是一个C语言的类型，比如<code>int</code>这样的。 </p>
<p><code>_genericCls</code>这个变量在精简版里没用到，我只是放在这里，YYModel 可以给容器型的属性转换，具体可以看YY大神的文档。</p>
<p><code>_isKVCCompatible</code> 能不能支持 KVC</p>
<p><code>_mappedToKey</code> 要映射的 key，把 JSON 转成 Model 的时会根据这个 key 把相同字段的 JSON 值赋值给这个 Property。</p>
<p>为了判断 NS 的类型和是否是 C 类型，在 <code>.m</code> 里有两个函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#define force_inline __inline__ __attribute__((always_inline))</span><br><span class="line"></span><br><span class="line">static force_inline CPEncodingNSType CPClassGetNSType(Class cls) &#123;</span><br><span class="line">    if (!cls) return CPEncodingTypeNSUnknown;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSMutableString class]]) return CPEncodingTypeNSMutableString;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSString class]]) return CPEncodingTypeNSString;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSDecimalNumber class]]) return CPEncodingTypeNSDecimalNumber;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSNumber class]]) return CPEncodingTypeNSNumber;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSValue class]]) return CPEncodingTypeNSValue;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSMutableData class]]) return CPEncodingTypeNSMutableData;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSData class]]) return CPEncodingTypeNSData;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSDate class]]) return CPEncodingTypeNSDate;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSURL class]]) return CPEncodingTypeNSURL;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSMutableArray class]]) return CPEncodingTypeNSMutableArray;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSArray class]]) return CPEncodingTypeNSArray;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSMutableDictionary class]]) return CPEncodingTypeNSMutableDictionary;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSDictionary class]]) return CPEncodingTypeNSDictionary;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSMutableSet class]]) return CPEncodingTypeNSMutableSet;</span><br><span class="line">    if ([cls isSubclassOfClass:[NSSet class]]) return CPEncodingTypeNSSet;</span><br><span class="line">    return CPEncodingTypeNSUnknown;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static force_inline BOOL CPEncodingTypeIsCNumber(CPEncodingType type) &#123;</span><br><span class="line">    switch (type &amp; CPEncodingTypeMask) &#123;</span><br><span class="line">        case CPEncodingTypeBool:</span><br><span class="line">        case CPEncodingTypeInt8:</span><br><span class="line">        case CPEncodingTypeUInt8:</span><br><span class="line">        case CPEncodingTypeInt16:</span><br><span class="line">        case CPEncodingTypeUInt16:</span><br><span class="line">        case CPEncodingTypeInt32:</span><br><span class="line">        case CPEncodingTypeUInt32:</span><br><span class="line">        case CPEncodingTypeInt64:</span><br><span class="line">        case CPEncodingTypeUInt64:</span><br><span class="line">        case CPEncodingTypeFloat:</span><br><span class="line">        case CPEncodingTypeDouble:</span><br><span class="line">        case CPEncodingTypeLongDouble: return YES;</span><br><span class="line">        default: return NO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个函数不用多说了，很简单，要说明一下宏定义 <code>force_inline</code> 所有标记了 <code>force_inline</code> 的函数叫做内联函数，在调用的时候都不是一般的调用，而是在编译的时候就已经整个丢进了调用这个函数的方法或函数里去了，这和平时定义一个宏一样，你在哪里使用到了这个宏，那么在编译的时候编译器就会把你使用这个宏的地方替换成宏的值。为什么要这么做呢？因为效率，调用一个函数也是有开销的，调用一个函数有压栈弹栈等操作。如果你的函数很小，你这么一弄就免去了这些操作。</p>
<p>然后看一下<code>CPModelPropertyMeta</code>的初始化方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)modelWithClassInfo:(CPClassInfo *)clsInfo propretyInfo:(CPClassPropertyInfo *)propertyInfo generic:(Class)generic&#123;</span><br><span class="line">    CPModelPropertyMeta *meta = [self new];</span><br><span class="line">    meta-&gt;_name = propertyInfo.name;</span><br><span class="line">    meta-&gt;_type = propertyInfo.type;</span><br><span class="line">    meta-&gt;_info = propertyInfo;</span><br><span class="line">    meta-&gt;_genericCls = generic;</span><br><span class="line">    </span><br><span class="line">    if ((meta-&gt;_type &amp; CPEncodingTypeMask) == CPEncodingTypeObject) &#123;</span><br><span class="line">        meta-&gt;_nsType = CPClassGetNSType(propertyInfo.cls);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        meta-&gt;_isCNumber = CPEncodingTypeIsCNumber(meta-&gt;_type);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    meta-&gt;_cls = propertyInfo.cls;</span><br><span class="line">    </span><br><span class="line">    if (propertyInfo.getter) &#123;</span><br><span class="line">        if ([clsInfo.cls instancesRespondToSelector:propertyInfo.getter]) &#123;</span><br><span class="line">            meta-&gt;_getter = propertyInfo.getter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (propertyInfo.setter) &#123;</span><br><span class="line">        if ([clsInfo.cls instancesRespondToSelector:propertyInfo.setter]) &#123;</span><br><span class="line">            meta-&gt;_setter = propertyInfo.setter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (meta-&gt;_setter &amp;&amp; meta-&gt;_getter) &#123;</span><br><span class="line">        switch (meta-&gt;_type &amp; CPEncodingTypeMask) &#123;</span><br><span class="line">            case CPEncodingTypeBool:</span><br><span class="line">            case CPEncodingTypeInt8:</span><br><span class="line">            case CPEncodingTypeUInt8:</span><br><span class="line">            case CPEncodingTypeInt16:</span><br><span class="line">            case CPEncodingTypeUInt16:</span><br><span class="line">            case CPEncodingTypeInt32:</span><br><span class="line">            case CPEncodingTypeUInt32:</span><br><span class="line">            case CPEncodingTypeInt64:</span><br><span class="line">            case CPEncodingTypeUInt64:</span><br><span class="line">            case CPEncodingTypeFloat:</span><br><span class="line">            case CPEncodingTypeDouble:</span><br><span class="line">            case CPEncodingTypeObject:</span><br><span class="line">            case CPEncodingTypeClass:</span><br><span class="line">            case CPEncodingTypeBlock:</span><br><span class="line">            case CPEncodingTypeStruct:</span><br><span class="line">            case CPEncodingTypeUnion: &#123;</span><br><span class="line">                meta-&gt;_isKVCCompatible = YES;</span><br><span class="line">            &#125; break;</span><br><span class="line">            default: break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断一下是否是 object 的类型，然后拿到具体的 NS 类型，或者判断一下是不是 C 类型，然后拿到 <code>getter</code> <code>setter</code> 最后判断一下能不能 KVC。</p>
<h4 id="CPModelPropertyMeta-1"><a href="#CPModelPropertyMeta-1" class="headerlink" title="CPModelPropertyMeta"></a>CPModelPropertyMeta</h4><p>这个类主要是生成一个映射表，这个映射表就是 <code>_mapper</code> 这个变量，这个类也需要被缓存起来，套路和上面讲到的缓存套路一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)metaWithClass:(Class)cls &#123;</span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">    static CFMutableDictionaryRef cache;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    static dispatch_semaphore_t lock;</span><br><span class="line">    </span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        cache = CFDictionaryCreateMutable(CFAllocatorGetDefault(), 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        lock = dispatch_semaphore_create(1);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    CPModelMeta *meta = CFDictionaryGetValue(cache, (__bridge const void *)(cls));</span><br><span class="line">    dispatch_semaphore_signal(lock);</span><br><span class="line">    </span><br><span class="line">    if (!meta || meta-&gt;_clsInfo.needUpdate) &#123;</span><br><span class="line">        meta = [[CPModelMeta alloc] initWithClass:cls];</span><br><span class="line">        if (meta) &#123;</span><br><span class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            CFDictionarySetValue(cache, (__bridge const void *)(cls), (__bridge const void *)(meta));</span><br><span class="line">            dispatch_semaphore_signal(lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缓存没命中就调用 <code>initWithClass:</code> 来进行初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithClass:(Class)cls&#123;</span><br><span class="line">    if (!cls) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        CPClassInfo *clsInfo = [CPClassInfo classInfoWithClass:cls];</span><br><span class="line">        NSMutableDictionary *allPropertyMetas = [NSMutableDictionary new];</span><br><span class="line">        CPClassInfo *curClsInfo = clsInfo;</span><br><span class="line">        //连同当前的类和其父类的属性一起放入allPropertyMetas数组，(NSObject和NSProxy是没有父类的）</span><br><span class="line">        while (curClsInfo &amp;&amp; curClsInfo.superClass != nil) &#123;</span><br><span class="line">            for (CPClassPropertyInfo *propertyInfo in curClsInfo.propertyInfos.allValues) &#123;</span><br><span class="line">                if (!propertyInfo.name)continue;</span><br><span class="line">                CPModelPropertyMeta *meta = [CPModelPropertyMeta modelWithClassInfo:clsInfo propretyInfo:propertyInfo generic:nil];</span><br><span class="line">                if (!meta || !meta-&gt;_name)continue;</span><br><span class="line">                if (!meta-&gt;_setter || !meta-&gt;_getter)continue;</span><br><span class="line">                if (allPropertyMetas[meta-&gt;_name])continue;</span><br><span class="line">                allPropertyMetas[meta-&gt;_name] = meta;</span><br><span class="line">            &#125;</span><br><span class="line">            curClsInfo = clsInfo.superClassInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (allPropertyMetas.count) &#123;</span><br><span class="line">            _allPropertyMetas = allPropertyMetas.allValues.copy;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        NSMutableDictionary *mapper = [NSMutableDictionary new];</span><br><span class="line">        </span><br><span class="line">        [allPropertyMetas enumerateKeysAndObjectsUsingBlock:^(NSString *  _Nonnull name, CPModelPropertyMeta *  _Nonnull meta, BOOL * _Nonnull stop) &#123;</span><br><span class="line">            meta-&gt;_mappedToKey = name;</span><br><span class="line">            mapper[name] = meta;</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        if (mapper.count) _mapper = mapper;</span><br><span class="line">        _clsInfo = clsInfo;</span><br><span class="line">        _keyMappedCount = _allPropertyMetas.count;</span><br><span class="line">        _nsType = CPClassGetNSType(cls);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把 <code>CPClassInfo</code> 里所有的 <code>propertyInfo</code> 遍历出来，实例化成一个 <code>CPModelPropertyMeta</code> ，还顺便把 <code>CPClassInfo</code> 父类的所有 <code>propertyInfo</code> 也拿出来，这样一来，你的 Model 即便有一个父类也能把父类的 Property 赋值。</p>
<p>然后生成一个映射表，就基本完成了初始化工作了，这张映射表是关键，等一下所有的 JSON 的转换都依赖这一张表。</p>
<h2 id="从-JSON-到-Model-的转换"><a href="#从-JSON-到-Model-的转换" class="headerlink" title="从 JSON 到 Model 的转换"></a>从 JSON 到 Model 的转换</h2><p>现在进入正餐环节，我们刚才已经把所有的准备工作完成了，现在要开始正式的完成从 JSON 到 Model 的转换了。</p>
<p>首先，先建一个 Category，取名 CPModel，因为我们只完成整个 YYMode 的一个主要功能，所以我们只给出一个接口就行了，所以头文件很简单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface NSObject (CPModel)</span><br><span class="line"></span><br><span class="line">+ (instancetype)modelWithJSON:(id)json;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>使用者只需要调用 <code>+ modelWithJSON:</code> 即可完成转换的操作。</p>
<p>现在看看这个方法要怎么实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)modelWithJSON:(id)json &#123;</span><br><span class="line">    NSDictionary *dic = [self _cp_dictionaryWithJSON:json];</span><br><span class="line">    if (!dic || dic == (id)kCFNull) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    if (![dic isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Class cls = [self class];</span><br><span class="line">    </span><br><span class="line">	NSObject *one = [cls new];</span><br><span class="line">    if ([one modelSetWithDictionary:dic]) &#123;</span><br><span class="line">        return one;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先先把 JSON 转换成 NSDictionary ，然后得到该 Model 的 Class 去实例化这个 Model，接着调用一个叫做<code>- modelSetWithDictionary:</code> 的方法。</p>
<p>把 JSON 转换成 NSDictionary 的方法很简单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (NSDictionary *)_cp_dictionaryWithJSON:(id)json&#123;</span><br><span class="line">    if (!json || json == (id)kCFNull) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    NSDictionary *dic = nil;</span><br><span class="line">    NSData *data = nil;</span><br><span class="line">    if ([json isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">        dic = json;</span><br><span class="line">    &#125;else if ([json isKindOfClass:[NSString class]]) &#123;</span><br><span class="line">        data = [(NSString *)json dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    &#125;else if ([json isKindOfClass:[NSData class]]) &#123;</span><br><span class="line">        data = json;</span><br><span class="line">    &#125;</span><br><span class="line">    if (data) &#123;</span><br><span class="line">        dic = [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableLeaves error:nil];</span><br><span class="line">        if (![dic isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">            dic = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return dic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后看一下 <code>- modelSetWithDictionary:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)modelSetWithDictionary:(NSDictionary *)dic&#123;</span><br><span class="line">    if (!dic || dic == (id)kCFNull) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    if (![dic isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    CPModelMeta *meta = [CPModelMeta metaWithClass:object_getClass(self)]; //①</span><br><span class="line">    if (meta-&gt;_keyMappedCount == 0) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ModelSetContext context = &#123;0&#125;;</span><br><span class="line">    context.modelMeta = (__bridge void *)(meta);</span><br><span class="line">    context.model = (__bridge void *)(self);</span><br><span class="line">    context.dictionary = (__bridge void *)(dic);</span><br><span class="line">    </span><br><span class="line">    if (meta-&gt;_keyMappedCount &gt;= dic.count) &#123;</span><br><span class="line">        CFDictionaryApplyFunction((CFDictionaryRef)dic, ModelSetWithDictionaryFunction, &amp;context);</span><br><span class="line">    &#125;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个结构体，这个结构体用来存储 <code>model</code>（因为是给这个Model 里的 Property 赋值）、<code>modelMeta</code>（刚才也看到了，这里存放了映射表）、<code>dictionary</code>（这是由 JSON 转换过来的），这个结构体的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">    void *modelMeta;</span><br><span class="line">    void *model;</span><br><span class="line">    void *dictionary;</span><br><span class="line">&#125; ModelSetContext;</span><br></pre></td></tr></table></figure>
<p>然后在<code>- modelSetWithDictionary:</code>有这么一行代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFDictionaryApplyFunction((CFDictionaryRef)dic, ModelSetWithDictionaryFunction, &amp;context);</span><br></pre></td></tr></table></figure>
<p>这个代码的作用是，把一对 <code>Key - Value</code> 拿出来，然后调用你传进去的函数<code>ModelSetWithDictionaryFunction()</code>，你有多少对<code>Key - Value</code>，它就会调用多少次这个函数，相当于便利所有的<code>Key - Value</code>，为什么要这样做，而不用一个循环呢？在YY大神的博客里有这么一段</p>
<blockquote>
<p>遍历容器类时，选择更高效的方法</p>
<p>相对于 Foundation 的方法来说，CoreFoundation 的方法有更高的性能，用 CFArrayApplyFunction() 和 CFDictionaryApplyFunction() 方法来遍历容器类能带来不少性能提升，但代码写起来会非常麻烦。</p>
</blockquote>
<p>然后我们来看一下<code>ModelSetWithDictionaryFunction()</code>的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void ModelSetWithDictionaryFunction(const void *key, const void *value, void *context) &#123;</span><br><span class="line">    ModelSetContext *ctx = context;</span><br><span class="line">    __unsafe_unretained CPModelMeta *modelMeta = (__bridge CPModelMeta *)(ctx-&gt;modelMeta);</span><br><span class="line">    __unsafe_unretained CPModelPropertyMeta *propertyMeta = [modelMeta-&gt;_mapper objectForKey:(__bridge id)(key)];</span><br><span class="line">    __unsafe_unretained id model = (__bridge id)(ctx-&gt;model);</span><br><span class="line">    if (propertyMeta-&gt;_setter) &#123;</span><br><span class="line">        ModelSetValueForProperty(model, (__bridge __unsafe_unretained id)value, propertyMeta);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么在变量前都加了<code>__unsafe_unretained</code>，YY大神也说了</p>
<blockquote>
<p>避免多余的内存管理方法</p>
<p>在 ARC 条件下，默认声明的对象是 <strong>strong 类型的，赋值时有可能会产生 retain/release 调用，如果一个变量在其生命周期内不会被释放，则使用 </strong>unsafe_unretained 会节省很大的开销。</p>
<p>访问具有 <strong>weak 属性的变量时，实际上会调用 objc_loadWeak() 和 objc_storeWeak() 来完成，这也会带来很大的开销，所以要避免使用 </strong>weak 属性。</p>
</blockquote>
<p>继续，根据 key（这个 key 就是 JSON 里的字段，应该和你 Model 定义的 Property 名相同，否则就匹配不了，在 YYMode 中有一个自定义映射表的支持，我把它去掉了，有兴趣的可以下载 YYMode 的源码看一下） 取出映射表里的 <code>propertyMeta</code>。现在我们有了要转换的 model 对象，和一个和 JSON 里字段对应的 <code>propertyMeta</code> 对象，已经该 JSON 字段的值，现在要赋值的条件全部具备了，我们只需要调用<code>propertyMeta</code>中的<code>setter</code>方法，然后把值传进去就完成了，这部分的工作由 <code>ModelSetValueForProperty()</code>函数完成，这个函数里有大量的类型判断，为了简单起见，我就判断了<code>NSString</code> <code>NSNumber</code> 和普通C语言类型，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">static void ModelSetValueForProperty(__unsafe_unretained id model, __unsafe_unretained id value, __unsafe_unretained CPModelPropertyMeta *meta) &#123;</span><br><span class="line">    if (meta-&gt;_isCNumber) &#123;</span><br><span class="line">        NSNumber *num = CPNSNumberCreateFromID(value);</span><br><span class="line">        ModelSetNumberToProperty(model, num, meta);</span><br><span class="line">        if (num) [num class];</span><br><span class="line">    &#125; else if (meta-&gt;_nsType) &#123;</span><br><span class="line">        if (value == (id)kCFNull) &#123;</span><br><span class="line">            ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (id)nil);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            switch (meta-&gt;_nsType) &#123;</span><br><span class="line">                case CPEncodingTypeNSString:</span><br><span class="line">                case CPEncodingTypeNSMutableString: &#123;</span><br><span class="line">                    if ([value isKindOfClass:[NSString class]]) &#123;</span><br><span class="line">                        if (meta-&gt;_nsType == CPEncodingTypeNSString) &#123;</span><br><span class="line">                            ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, value);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, ((NSString *)value).mutableCopy);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if ([value isKindOfClass:[NSNumber class]]) &#123;</span><br><span class="line">                        ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model,</span><br><span class="line">                                                                       meta-&gt;_setter,</span><br><span class="line">                                                                       (meta-&gt;_nsType == CPEncodingTypeNSString) ?</span><br><span class="line">                                                                       ((NSNumber *)value).stringValue :</span><br><span class="line">                                                                       ((NSNumber *)value).stringValue.mutableCopy);</span><br><span class="line">                    &#125; else if ([value isKindOfClass:[NSData class]]) &#123;</span><br><span class="line">                        NSMutableString *string = [[NSMutableString alloc] initWithData:value encoding:NSUTF8StringEncoding];</span><br><span class="line">                        ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, string);</span><br><span class="line">                    &#125; else if ([value isKindOfClass:[NSURL class]]) &#123;</span><br><span class="line">                        ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model,</span><br><span class="line">                                                                       meta-&gt;_setter,</span><br><span class="line">                                                                       (meta-&gt;_nsType == CPEncodingTypeNSString) ?</span><br><span class="line">                                                                       ((NSURL *)value).absoluteString :</span><br><span class="line">                                                                       ((NSURL *)value).absoluteString.mutableCopy);</span><br><span class="line">                    &#125; else if ([value isKindOfClass:[NSAttributedString class]]) &#123;</span><br><span class="line">                        ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model,</span><br><span class="line">                                                                       meta-&gt;_setter,</span><br><span class="line">                                                                       (meta-&gt;_nsType == CPEncodingTypeNSString) ?</span><br><span class="line">                                                                       ((NSAttributedString *)value).string :</span><br><span class="line">                                                                       ((NSAttributedString *)value).string.mutableCopy);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; break;</span><br><span class="line">                case CPEncodingTypeNSNumber:&#123;</span><br><span class="line">                    if ([value isKindOfClass:[NSNumber class]]) &#123;</span><br><span class="line">                        if (meta-&gt;_nsType == CPEncodingTypeNSNumber) &#123;</span><br><span class="line">                            ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model,meta-&gt;_setter,value);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; break;</span><br><span class="line">                    </span><br><span class="line">                default: break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 <code>objc_msgSend()</code> 我们随便拿一行例子来举例，比如这个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, value);</span><br></pre></td></tr></table></figure>
<p>这是一个可以调用者决定返回值和参数的函数，一般的函数是做不到的，默认情况下这个函数是长这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend(id, SEL)</span><br></pre></td></tr></table></figure>
<p><code>id</code> 是指调用某一个方法的对象，在这里这个对象就是你的 Model</p>
<p><code>SEL</code> 是指你这个对象要调用的方法是什么，在这里这个方法就是 <code>setter</code>方法</p>
<p>然而，<code>setter</code> 方法是有参数的，这个参数怎么传进去？这就需要强制类型转换了，我们把这个函数强制转换成这个模样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((void (*)(id, SEL, id))(void *) objc_msgSend)</span><br></pre></td></tr></table></figure>
<p>这样代表这个函数是一个没有返回值，并且有3个参数的函数，分别是 <code>id</code> <code>SEL</code> <code>id</code>，前面两个参数之前讲过了，第三个参数就是你要调用的这个 <code>setter</code> 方法需要的参数，所以经过强制类型转换之后的变异版就成了一开始的那种样子。</p>
<p>其余的都没有什么好讲的了，都很简单，都是一些烦人的类型判断，只要仔细一点一行行看就能看懂了。</p>
<p>全部搞定以后，和原版的 YYModel 一样，你可以这么来测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPTestModel *model = [CPTestModel modelWithJSON:@&quot;&#123;\&quot;name\&quot;: \&quot;Harry Potter\&quot;,\&quot;index\&quot;: 512,\&quot;number\&quot;: 10,\&quot;num\&quot;: 100&#125;&quot;];</span><br></pre></td></tr></table></figure>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>如果你自己亲自动手写完了这个精简版的 YYMode ，你再去看完整版的会容易很多，我写的这篇文章是把我从读 YYModel 源码中学到的一些有用的东西分享给大家，如有什么写错的地方，欢迎指正。</p>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><p>点击<a href="https://github.com/J0HDev/CPModel" target="_blank" rel="external">这里</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag">#iOS</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/12/inline-attribute-always-inline-的意思/" rel="next" title="__inline__ __attribute__((always_inline)) 的意思">
                <i class="fa fa-chevron-left"></i> __inline__ __attribute__((always_inline)) 的意思
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/09/02/手把手带你撸一个-YYModel-的精简版/"
           data-title="手把手带你撸一个 YYModel 的精简版" data-url="http://yoursite.com/2016/09/02/手把手带你撸一个-YYModel-的精简版/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="J0hnnny" />
          <p class="site-author-name" itemprop="name">J0hnnny</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/jcack" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/j0hdev" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#从JSON映射到Model的原理"><span class="nav-number">1.</span> <span class="nav-text">从JSON映射到Model的原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前期的准备工作"><span class="nav-number">2.</span> <span class="nav-text">前期的准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#封装-ivar"><span class="nav-number">2.1.</span> <span class="nav-text">封装 ivar</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一个强大的枚举"><span class="nav-number">2.1.1.</span> <span class="nav-text">一个强大的枚举</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#封装Method"><span class="nav-number">2.2.</span> <span class="nav-text">封装Method</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Objective-C-的-Optional"><span class="nav-number">2.2.1.</span> <span class="nav-text">Objective-C 的 Optional</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#封装-Property"><span class="nav-number">2.3.</span> <span class="nav-text">封装 Property</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#封装-Class"><span class="nav-number">2.4.</span> <span class="nav-text">封装 Class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#继续封装"><span class="nav-number">2.5.</span> <span class="nav-text">继续封装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CPModelPropertyMeta"><span class="nav-number">2.5.1.</span> <span class="nav-text">CPModelPropertyMeta</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CPModelPropertyMeta-1"><span class="nav-number">2.5.2.</span> <span class="nav-text">CPModelPropertyMeta</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从-JSON-到-Model-的转换"><span class="nav-number">3.</span> <span class="nav-text">从 JSON 到 Model 的转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结尾"><span class="nav-number">4.</span> <span class="nav-text">结尾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#完整代码"><span class="nav-number">4.0.1.</span> <span class="nav-text">完整代码</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">J0hnnny</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"j0hdev"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
